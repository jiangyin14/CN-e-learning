name: Process School Information Issue
on:
  issues:
    types: [labeled, edited, reopened]

jobs:
  check-and-process-school-info:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'å­¦æ ¡ä¿¡æ¯å¡«æŠ¥') &&
      (github.event.action == 'labeled' || github.event.action == 'edited' || github.event.action == 'reopened')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for school names in docs
      id: check-school-names
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
      run: |
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥å®‰å…¨å¤„ç†issueå†…å®¹
        echo "$ISSUE_TITLE" > issue_content.txt
        echo "$ISSUE_BODY" >> issue_content.txt
        
        # æ£€æŸ¥/main/docs/guide/schoolç›®å½•ä¸‹çš„æ–‡ä»¶
        SCHOOL_FILES=$(find main/docs/guide/school -type f 2>/dev/null || find ./main/docs/guide/school -type f 2>/dev/null || true)
        
        MATCH_FOUND="false"
        
        if [ -n "$SCHOOL_FILES" ]; then
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file" | cut -d. -f1)  # åªå–æ–‡ä»¶åï¼Œå»æ‰æ‰©å±•å
              echo "æ£€æŸ¥æ–‡ä»¶: $FILENAME"
              
              # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ…å«åœ¨issueå†…å®¹ä¸­
              if grep -q "$FILENAME" issue_content.txt; then
                echo "æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶: $FILENAME"
                MATCH_FOUND="true"
                break
              fi
            fi
          done <<< "$SCHOOL_FILES"
        else
          echo "æœªæ‰¾åˆ°å­¦æ ¡æ–‡ä»¶ç›®å½•: main/docs/guide/school"
          # å°è¯•å…¶ä»–å¯èƒ½çš„è·¯å¾„
          SCHOOL_FILES=$(find . -path "*/docs/guide/school/*" -type f 2>/dev/null || true)
          if [ -n "$SCHOOL_FILES" ]; then
            echo "åœ¨å…¶ä»–è·¯å¾„æ‰¾åˆ°å­¦æ ¡æ–‡ä»¶"
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                FILENAME=$(basename "$file" | cut -d. -f1)
                echo "æ£€æŸ¥æ–‡ä»¶: $FILENAME"
                if grep -q "$FILENAME" issue_content.txt; then
                  echo "æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶: $FILENAME"
                  MATCH_FOUND="true"
                  break
                fi
              fi
            done <<< "$SCHOOL_FILES"
          fi
        fi
        
        echo "match_found=$MATCH_FOUND" >> $GITHUB_OUTPUT
        echo "æ£€æŸ¥ç»“æœ: $MATCH_FOUND"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f issue_content.txt

    - name: Process matching issue
      if: steps.check-school-names.outputs.match_found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.issue.number;
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          try {
            // æ·»åŠ è¯„è®º
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              body: 'ğŸ‘‹ æ‚¨çš„å­¦æ ¡ä¿¡æ¯å·²ç»ä¸Šä¼ è‡³ç½‘ç«™ï¼Œæ„Ÿè°¢åŠ å…¥å¤šæ ¡è”ç›Ÿï¼'
            });
            
            // æ›´æ–°æ ‡ç­¾
            await github.rest.issues.setLabels({
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              labels: ['å­¦æ ¡ä¿¡æ¯å¡«æŠ¥', 'å®¡æ ¸é€šè¿‡', 'æ·»åŠ å®Œæˆ']
            });
            
            // å…³é—­issue
            await github.rest.issues.update({
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              state: 'closed'
            });
            
            console.log(`æˆåŠŸå¤„ç†issue #${issueNumber}`);
          } catch (error) {
            console.error('å¤„ç†issueæ—¶å‡ºé”™:', error);
          }

    - name: Debug info
      if: always()
      run: |
        echo "Issue Title: ${{ github.event.issue.title }}"
        echo "Match Found: ${{ steps.check-school-names.outputs.match_found }}"
        echo "å½“å‰ç›®å½•ç»“æ„:"
        find . -name "docs" -type d 2>/dev/null || echo "æœªæ‰¾åˆ°docsç›®å½•"
