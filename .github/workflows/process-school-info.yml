name: Process School Information on Commit
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-and-process-school-info:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get changed files in school directory
      id: get-changed-files
      run: |
        # è·å–æœ€è¿‘commitä¸­ä¿®æ”¹çš„æ–‡ä»¶
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- "main/docs/guide/school/" "docs/guide/school/" 2>/dev/null || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„è·¯å¾„
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- "*/docs/guide/school/*" 2>/dev/null || true)
        fi
        
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "æ£€æµ‹åˆ°çš„å˜æ›´æ–‡ä»¶:"
        echo "$CHANGED_FILES"

    - name: Extract school names from changed files
      id: extract-school-names
      if: steps.get-changed-files.outputs.changed_files != ''
      run: |
        CHANGED_FILES="${{ steps.get-changed-files.outputs.changed_files }}"
        
        SCHOOL_NAMES=""
        while IFS= read -r file; do
          if [ -n "$file" ] && [ -f "$file" ]; then
            # ä»æ–‡ä»¶åæå–å­¦æ ¡åç§°ï¼ˆå»æ‰è·¯å¾„å’Œæ‰©å±•åï¼‰
            FILENAME=$(basename "$file")
            SCHOOL_NAME=$(echo "$FILENAME" | sed 's/\.[^.]*$//')  # å»æ‰æ–‡ä»¶æ‰©å±•å
            if [ -n "$SCHOOL_NAME" ]; then
              SCHOOL_NAMES="${SCHOOL_NAMES}${SCHOOL_NAME}\n"
              echo "æå–çš„å­¦æ ¡åç§°: $SCHOOL_NAME"
            fi
          fi
        done <<< "$CHANGED_FILES"
        
        echo "school_names<<EOF" >> $GITHUB_OUTPUT
        echo -e "$SCHOOL_NAMES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Find related issues
      id: find-issues
      if: steps.extract-school-names.outputs.school_names != ''
      run: |
        # åˆ›å»ºåŒ…å«å­¦æ ¡åç§°çš„ä¸´æ—¶æ–‡ä»¶
        echo -e "${{ steps.extract-school-names.outputs.school_names }}" > school_names.txt
        
        echo "å¼€å§‹æœç´¢ç›¸å…³issue..."
        
        # ä½¿ç”¨GitHub CLIæœç´¢åŒ…å«å­¦æ ¡åç§°çš„issue
        ISSUE_LIST=""
        while IFS= read -r school_name; do
          if [ -n "$school_name" ]; then
            echo "æœç´¢åŒ…å« '$school_name' çš„issue..."
            
            # æœç´¢æ ‡é¢˜æˆ–å†…å®¹åŒ…å«å­¦æ ¡åç§°ä¸”å¸¦æœ‰"å­¦æ ¡ä¿¡æ¯å¡«æŠ¥"æ ‡ç­¾çš„open issue
            ISSUES=$(gh api search/issues -q "repo:${{ github.repository }} \"$school_name\" label:\"å­¦æ ¡ä¿¡æ¯å¡«æŠ¥\" state:open" --jq '.items[].number' 2>/dev/null || true)
            
            if [ -n "$ISSUES" ]; then
              for issue_num in $ISSUES; do
                echo "æ‰¾åˆ°ç›¸å…³issue: #$issue_num"
                ISSUE_LIST="${ISSUE_LIST}${issue_num}\n"
              done
            fi
          fi
        done < school_names.txt
        
        echo "issue_list<<EOF" >> $GITHUB_OUTPUT
        echo -e "$ISSUE_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f school_names.txt

    - name: Process matching issues
      if: steps.find-issues.outputs.issue_list != ''
      uses: actions/github-script@v7
      env:
        ISSUE_LIST: ${{ steps.find-issues.outputs.issue_list }}
      with:
        script: |
          const issueList = process.env.ISSUE_LIST.split('\n').filter(num => num.trim() !== '');
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          console.log(`æ‰¾åˆ° ${issueList.length} ä¸ªéœ€è¦å¤„ç†çš„issue:`, issueList);
          
          for (const issueNumber of issueList) {
            if (!issueNumber) continue;
            
            try {
              console.log(`å¤„ç†issue #${issueNumber}`);
              
              // æ·»åŠ è¯„è®º
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: parseInt(issueNumber),
                body: 'ğŸ‘‹ æ‚¨çš„å­¦æ ¡ä¿¡æ¯å·²ç»ä¸Šä¼ è‡³ç½‘ç«™ï¼Œæ„Ÿè°¢åŠ å…¥å¤šæ ¡è”ç›Ÿï¼'
              });
              
              // æ›´æ–°æ ‡ç­¾
              await github.rest.issues.setLabels({
                owner: owner,
                repo: repo,
                issue_number: parseInt(issueNumber),
                labels: ['å­¦æ ¡ä¿¡æ¯å¡«æŠ¥', 'å®¡æ ¸é€šè¿‡', 'æ·»åŠ å®Œæˆ']
              });
              
              // å…³é—­issue
              await github.rest.issues.update({
                owner: owner,
                repo: repo,
                issue_number: parseInt(issueNumber),
                state: 'closed'
              });
              
              console.log(`æˆåŠŸå¤„ç†issue #${issueNumber}`);
            } catch (error) {
              console.error(`å¤„ç†issue #${issueNumber}æ—¶å‡ºé”™:`, error);
            }
          }

    - name: Debug info
      if: always()
      run: |
        echo "å˜æ›´æ–‡ä»¶: ${{ steps.get-changed-files.outputs.changed_files }}"
        echo "æå–çš„å­¦æ ¡åç§°: ${{ steps.extract-school-names.outputs.school_names }}"
        echo "æ‰¾åˆ°çš„issueåˆ—è¡¨: ${{ steps.find-issues.outputs.issue_list }}"
        echo "å½“å‰commit: ${{ github.sha }}"
