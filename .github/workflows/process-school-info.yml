name: Process School Information Issue
on:
  issues:
    types: [labeled, edited, reopened]

jobs:
  check-and-process-school-info:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'å­¦æ ¡ä¿¡æ¯å¡«æŠ¥') &&
      (github.event.action == 'labeled' || github.event.action == 'edited' || github.event.action == 'reopened')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get issue body and title
      id: get-issue-data
      run: |
        ISSUE_BODY=$(echo '${{ github.event.issue.body }}' | sed 's/"/\\"/g')
        ISSUE_TITLE=$(echo '${{ github.event.issue.title }}' | sed 's/"/\\"/g')
        echo "issue_body=${ISSUE_BODY}" >> $GITHUB_OUTPUT
        echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT

    - name: Check for school names in docs
      id: check-school-names
      run: |
        # è·å–issueä¸­çš„æ‰€æœ‰æ–‡æœ¬ï¼ˆæ ‡é¢˜+å†…å®¹ï¼‰
        ISSUE_TEXT="${{ steps.get-issue-data.outputs.issue_title }} ${{ steps.get-issue-data.outputs.issue_body }}"
        
        # æ£€æŸ¥/main/docs/guide/schoolç›®å½•ä¸‹çš„æ–‡ä»¶
        SCHOOL_FILES=$(find main/docs/guide/school -type f -name "*.md" -o -name "*.txt" -o -name "*.json" 2>/dev/null || true)
        
        MATCH_FOUND="false"
        
        if [ -n "$SCHOOL_FILES" ]; then
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ…å«åœ¨issueæ–‡æœ¬ä¸­
              if echo "$ISSUE_TEXT" | grep -q "$FILENAME"; then
                echo "æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶: $FILENAME"
                MATCH_FOUND="true"
                break
              fi
            fi
          done <<< "$SCHOOL_FILES"
        fi
        
        echo "match_found=$MATCH_FOUND" >> $GITHUB_OUTPUT

    - name: Process matching issue
      if: steps.check-school-names.outputs.match_found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.issue.number;
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          try {
            // æ·»åŠ è¯„è®º
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              body: 'ğŸ‘‹ æ‚¨çš„å­¦æ ¡ä¿¡æ¯å·²ç»ä¸Šä¼ è‡³ç½‘ç«™ï¼Œæ„Ÿè°¢åŠ å…¥å¤šæ ¡è”ç›Ÿï¼'
            });
            
            // æ›´æ–°æ ‡ç­¾
            await github.rest.issues.setLabels({
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              labels: ['å­¦æ ¡ä¿¡æ¯å¡«æŠ¥', 'å®¡æ ¸é€šè¿‡', 'æ·»åŠ å®Œæˆ']
            });
            
            // å…³é—­issue
            await github.rest.issues.update({
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              state: 'closed'
            });
            
            console.log(`æˆåŠŸå¤„ç†issue #${issueNumber}`);
          } catch (error) {
            console.error('å¤„ç†issueæ—¶å‡ºé”™:', error);
          }
